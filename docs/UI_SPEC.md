# 用户界面规范（Web 访谈端 + 管理后台）

版本：v1.0  
适用范围：`src/interview_system/ui/web_ui.py`（访谈 Web UI）、`src/interview_system/ui/admin_ui.py`（管理后台 UI）、`src/interview_system/app/main.py`（启动/入口提示）  
目标读者：维护该仓库的开发者（Python/Gradio）

---

## 1. 设计目标（原则）

- 低学习成本：首次打开即可开始访谈，不要求注册/登录/配置。
- 强引导：明确“如何回答/如何跳过/如何重开”，减少无效输入。
- 明确状态：对“进行中/已结束/缺少依赖/导出成功”等状态给出可见反馈。
- 多会话隔离：不同浏览器标签页/用户之间互不干扰（单页状态隔离）。
- 视觉一致：保持统一主题（Gradio Soft）与“微信风格近似”的视觉 token（浅灰背景、左右气泡、底部输入条），避免引入多套风格。

---

## 2. 信息架构与入口

系统包含 3 个面向用户的入口：

1. 交互式入口：`python -m interview_system` → 选择 `1/2/3`
2. Web 访谈端（直达）：`python -m interview_system.app.web`
3. 管理后台（直达）：`python -m interview_system.app.admin`

端口与网络：

- Web 访谈端默认端口：`7860`（`interview_system.common.config:WEB_CONFIG.port`）
- 管理后台默认端口：`7861`（`WEB_CONFIG.port + 1`）
- Web 访谈端默认对外绑定：`0.0.0.0`（`WEB_CONFIG.host`）
- Web 访谈端默认生成公网链接：`True`（`WEB_CONFIG.share`）
- 管理后台禁止公网链接：`share=False`

---

## 3. 文案与语言规范

- 所有用户可见文本使用简体中文，符合当前产品语言。
- 标题/按钮可包含 Emoji（已在现有 UI 中使用），但要避免堆砌；同一语义保持一致图标。
- 标识符/变量/函数命名使用英文（代码层面），但不在本规范中强制约束。

---

## 4. Web 访谈端 UI 规范（`interview_system.ui.web_ui:create_web_interface`）

### 4.1 页面结构（布局）

页面采用 1 个顶栏区 + 1 行双列主区域：

- 顶栏（Header）：品牌标题 + 副标题
- 主区域：
  - 左列（scale=3）：对话区 + 进度区 + 输入与操作按钮
  - 右列（scale=1）：使用说明 + 小贴士 + 实时统计

### 4.2 视觉规范（主题 + CSS）

- Theme：`gr.themes.Soft()`
- 自定义 CSS（以 `elem_id` 为锚点，便于稳定选择器）：
  - `#wechat_header`：顶部栏容器（白底卡片、轻阴影）
  - `#wechat_chat`：聊天区域（浅灰背景 + 左右气泡样式）
  - `#wechat_input_bar`：底部输入条（`position: sticky`，移动端优先）
  - `#wechat_action_bar`：次要操作栏（撤回/跳过/重新开始）
  - `.stats-box` / `.progress-bar` / `.progress-fill`：进度卡片与进度条（弱化为系统信息样式）

### 4.3 组件规范（控件清单）

左列：

1. 对话组件：`gr.Chatbot`
   - `show_label=False`
   - `height=500`
   - `bubble_full_width=False`
   - 助手头像：机器人图（外链），用户头像为空
2. 进度展示：`gr.HTML`（`.stats-box` 容器）
   - 默认文案：`准备开始访谈...`
   - 进度条默认宽度：`0%`
3. 输入框：`gr.Textbox`
   - `show_label=False`
   - `lines=2` / `max_lines=5`
   - Placeholder：`请输入你的回答…`
4. 按钮：
   - 发送：`发送`（`variant="primary"`，位于输入条右侧）
   - 撤回：`↩️ 撤回`（`variant="secondary"`）
   - 跳过：`⏭️ 跳过此题`（`variant="secondary"`，语义为“跳过本轮”）
   - 重新开始：`🔄 重新开始`（`variant="secondary"`）

右列：

1. 使用说明（Markdown）：包含操作提示、访谈规则、小贴士（现有文案为准）
2. 实时统计（Markdown）：初始占位文案：`*访谈开始后显示统计*`

### 4.4 交互与状态机

#### 4.4.1 初始化

- 触发时机：页面加载（`demo.load`）
- 行为：
  - 创建 `WebInterviewHandler` 并生成新会话（`lazy_initialize`）
  - Chatbot 首屏必须包含两条 assistant 消息：
    1) 欢迎语  
    2) 第一个问题
- 约束：初始化必须快速完成，避免阻塞页面首屏渲染。

#### 4.4.2 发送回答

- 触发方式：输入框回车提交（`msg.submit`）或点击发送按钮（`submit_btn.click`）
- 输入校验：
  - 空输入：无动作（保持历史不变）
  - 会话未初始化：无动作（保持历史不变）
- 输出行为（聊天历史追加规则）：
  - 若会话已结束：追加 `[用户输入, "访谈已结束，请点击下方按钮开始新访谈。"]`，并将输入框置为不可交互
  - 正常回答：先追加 `[用户输入, None]`，再由系统补齐该条的 assistant 反馈（“收到/进入下一题”等）
  - 若触发追问：
    - assistant 追问以 `💡`（AI生成）或 `📝`（预设）作为前缀展示
  - 若访谈结束：
    - 自动导出会话 JSON
    - 追加结束语：`🎉 访谈结束！感谢你的参与。`
    - 禁用输入框

#### 4.4.3 跳过当前题

- 触发方式：点击“跳过此题”
- 行为：跳过本轮对话（当前题或当前追问）。当处于追问状态时，跳过追问并直接进入下一题。
- 输出：
  - 追加跳过确认提示（核心题/追问轮次提示文案可不同）
  - 若结束：同“发送回答-结束”处理（自动导出 + 禁用输入）
  - 若未结束：显示下一题

#### 4.4.4 重新开始

- 触发方式：点击“重新开始”
- 行为：
  - 新建 `WebInterviewHandler`（新会话）
  - 重置 Chatbot 历史到“欢迎语 + 第一个问题”
  - 恢复输入框可交互

#### 4.4.5 撤回

- 触发方式：点击“↩️ 撤回”
- 行为：
  - 撤回最近一次“会改变会话/日志”的操作（发送回答或跳过）
  - 必须同时回滚：UI 历史 + 会话状态（题序/追问/完成状态）+ SQLite 持久化日志（数据库可用时）
- 输出：
  - 撤回成功：聊天历史恢复到撤回前，输入框回填被撤回的文本（便于修改后重发）
  - 无可撤回内容：提示 `暂无可撤回内容。`
  - 回滚失败：提示 `撤回失败：数据回滚未成功，请稍后重试。`（不做部分回滚）

### 4.5 启动与外部可见反馈（控制台）

Web 模式启动后，控制台输出必须包含：

- 局域网访问地址（`http://{local_ip}:{port}`）
- 若启用 `share=True`：打印“正在生成公网链接”与最终公网链接
- 生成二维码（ASCII）并保存为 `access_code.png`（运行目录）

### 4.6 错误与降级

- 未安装依赖（`gradio`/`qrcode`/`PIL`）：
  - Web 访谈端不可启动
  - 控制台输出安装指引：`pip install gradio qrcode[pil]`
- 二维码生成失败：
  - 仅降级为不输出二维码图片，不影响 Web 服务运行

---

## 5. 管理后台 UI 规范（`interview_system.ui.admin_ui:create_admin_interface`）

### 5.1 页面结构

- 顶部固定文本区：标题 + 描述
- 主体使用 Tabs 分区：
  1) `📊 概览`
  2) `📋 会话列表`
  3) `🗄️ 数据管理`

### 5.2 Tab：概览

组件与行为：

- 统计卡片（`gr.Number`，只读）：
  - 总访谈数、完成访谈数、完成率（%）、平均深度分
- 刷新按钮：`🔄 刷新概览`
  - 行为：重新读取统计并刷新上述 4 个数字
- 趋势与报告：
  - 统计天数：`gr.Slider`（1–30，默认 7）
  - 图表：`gr.Plot`
  - 文字报告：`gr.Markdown`
  - 生成按钮：`📈 生成统计图表` → 输出图表 + 文字报告
  - 导出按钮：`💾 导出HTML报告` → 输出导出结果文案（含路径）

降级策略：

- 未安装 `plotly`：图表区返回警告文本，不抛异常，保持页面可用。

### 5.3 Tab：会话列表

组件与行为：

- 刷新列表按钮：`🔄 刷新列表`
  - 行为：加载全部会话（优先数据库）并刷新表格
- 会话表格：`gr.Dataframe`（只读）
  - 列定义（固定顺序）：`会话ID / 用户名 / 开始时间 / 结束时间 / 状态 / 记录数`
- 详情区：
  - 会话ID输入：`gr.Textbox`（用户从表格复制粘贴）
  - 查看详情：`👁️ 查看详情` → 输出：
    - 基本信息（Markdown）
    - 对话记录（Markdown，按序列出每条 Q/A + 深度分 + AI标识）
    - 话题统计（Markdown，场景/五育分布）
  - 导出会话：`💾 导出此会话` → 输出导出结果（含路径）

### 5.4 Tab：数据管理

内容与行为：

- 数据库说明（Markdown）：
  - 位置：`interview_data.db`（项目根目录）
  - 表：`sessions` / `conversation_logs`
  - 备份建议：定期备份数据库文件
- 批量导出：
  - 按钮：`📦 导出所有会话 (JSON)`
  - 输出：逐会话导出结果列表 + 汇总（成功数/总数）

### 5.5 错误与降级

- 未安装 `gradio`：管理后台不可启动，控制台输出安装指引：`pip install gradio plotly`
- 无数据：趋势图表与报告提示“暂无访谈数据”，不显示空图导致报错

---

## 6. 非功能性要求（UI 侧）

- 并发：同一服务允许多个浏览器会话并行使用；每个页面实例的状态必须隔离（通过 `gr.State` 保存 handler）。
- 可靠性：导出失败必须返回明确失败文案；不应在 UI 层静默失败。
- 隐私提示（文案层）：默认不展示任何 API Key 等敏感配置；导出文件与数据库可能包含敏感访谈内容，需在文档中提示用户妥善保管。

---

## 7. 未来增强（非本规范强制）

以下属于可选改进，不作为本规范的“必须实现项”：

- 访谈端的“进度条/实时统计”与实际会话状态联动更新（当前为静态占位）。
- 访谈端增加“导出当前会话”按钮（当前仅结束后自动导出）。
- 管理后台支持按日期/状态筛选与分页（当前为加载全部会话并在表格中呈现）。
